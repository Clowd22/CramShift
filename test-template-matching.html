<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CramShift - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ç‰ˆ</title>
  <style>
    body {
      font-family: "Noto Sans JP", sans-serif;
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
      background: #f7f9fc;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 1rem;
    }
    .section {
      margin: 2rem 0;
      padding: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    .section h2 {
      color: #0056b3;
      margin-top: 0;
    }
    label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: 600;
    }
    input[type="file"], input[type="range"] {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
    }
    button {
      background: #007bff;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin: 1rem 0.5rem 1rem 0;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #0056b3;
    }
    .result {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    .shift-result {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .shift-item {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .shift-item.shift-B { border-left: 4px solid #4CAF50; }
    .shift-item.shift-C { border-left: 4px solid #2196F3; }
    .shift-item.shift-D { border-left: 4px solid #FF9800; }
    .shift-item.shift-X { border-left: 4px solid #9C27B0; }
    .shift-item.shift-Y { border-left: 4px solid #F44336; }
    
    canvas {
      max-width: 100%;
      border: 1px solid #ddd;
      margin: 1rem 0;
      border-radius: 8px;
    }
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    .error {
      background: #ffebee;
      border: 1px solid #ef5350;
      color: #c62828;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .success {
      background: #e8f5e9;
      border: 1px solid #66bb6a;
      color: #2e7d32;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .info {
      background: #e3f2fd;
      border: 1px solid #64b5f6;
      color: #1565c0;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ç‰ˆ - ã‚·ãƒ•ãƒˆè¡¨è§£æ</h1>
    
    <div class="info">
      <strong>ğŸ“Œ èª¬æ˜ï¼š</strong> ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ã‚’ä½¿ã£ã¦ã‚·ãƒ•ãƒˆæ–‡å­—ï¼ˆB, C, D, X, Yï¼‰ã‚’æ¤œå‡ºã—ã€ãã®ä¸Šã«ã‚ã‚‹æ•°å­—ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡ºã™ã‚‹å®Ÿé¨“çš„ãªæ–¹æ³•ã§ã™ã€‚
    </div>

    <div class="section">
      <h2>ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <label for="uploadImage">ã‚·ãƒ•ãƒˆè¡¨ã®ç”»åƒã‚’é¸æŠï¼š</label>
      <input type="file" id="uploadImage" accept="image/*">
      <button onclick="analyzeWithTemplateMatching()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ã§è§£æ</button>
    </div>

    <div class="section">
      <h2>âš™ï¸ è§£æè¨­å®š</h2>
      <label>ãƒãƒƒãƒãƒ³ã‚°é–¾å€¤ï¼ˆ0-1ï¼‰ï¼š</label>
      <input type="range" id="threshold" min="0" max="1" step="0.05" value="0.5">
      <span id="thresholdValue">0.50</span>
      <small style="color: #666;">â€» é–¾å€¤ãŒä½ã„ã»ã©å¤šãæ¤œå‡ºã•ã‚Œã¾ã™ãŒã€èª¤æ¤œå‡ºã‚‚å¢—ãˆã¾ã™</small>
      
      <label style="margin-top: 1rem;">æœ€å°ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ï¼š</label>
      <input type="range" id="minSize" min="5" max="100" step="5" value="20">
      <span id="minSizeValue">20</span>

      <label style="margin-top: 1rem;">
        <input type="checkbox" id="debugMode"> ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆè©³ç´°ãƒ­ã‚°è¡¨ç¤ºï¼‰
      </label>
    </div>

    <div class="section">
      <h2>ğŸ¯ æ¤œå‡ºçµæœ</h2>
      <div id="result"></div>
      <canvas id="canvas"></canvas>
    </div>

    <div class="section">
      <h2>ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¢ºèª</h2>
      <p>ä»¥ä¸‹ã¯å„ã‚·ãƒ•ãƒˆæ–‡å­—ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã§ã™ã€‚å®Ÿéš›ã®ã‚·ãƒ•ãƒˆè¡¨ã®æ–‡å­—ã¨ã®ä¸€è‡´åº¦ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
        <div style="text-align: center;">
          <img id="template-B" src="template/B_time.png" style="max-width: 100px; border: 1px solid #ddd; padding: 0.5rem;" alt="B">
          <small>B</small>
        </div>
        <div style="text-align: center;">
          <img id="template-C" src="template/C_time.png" style="max-width: 100px; border: 1px solid #ddd; padding: 0.5rem;" alt="C">
          <small>C</small>
        </div>
        <div style="text-align: center;">
          <img id="template-D" src="template/D_time.png" style="max-width: 100px; border: 1px solid #ddd; padding: 0.5rem;" alt="D">
          <small>D</small>
        </div>
        <div style="text-align: center;">
          <img id="template-X" src="template/X_time.png" style="max-width: 100px; border: 1px solid #ddd; padding: 0.5rem;" alt="X">
          <small>X</small>
        </div>
        <div style="text-align: center;">
          <img id="template-Y" src="template/Y_time.png" style="max-width: 100px; border: 1px solid #ddd; padding: 0.5rem;" alt="Y">
          <small>Y</small>
        </div>
      </div>
      <button onclick="checkTemplateImages()" style="margin-top: 1rem;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ç¢ºèª</button>
      <div id="templateStatus" style="margin-top: 1rem;"></div>
    </div>
  </div>

  <!-- OpenCV.js ã‚’èª­ã¿è¾¼ã¿ -->
  <script async src="https://docs.opencv.org/4.5.2/opencv.js"></script>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v5.0.4/dist/tesseract.min.js"></script>

  <script>
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
    document.getElementById('threshold').addEventListener('input', (e) => {
      document.getElementById('thresholdValue').textContent = parseFloat(e.target.value).toFixed(2);
    });
    document.getElementById('minSize').addEventListener('input', (e) => {
      document.getElementById('minSizeValue').textContent = e.target.value;
    });

    /**
     * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã®èª­ã¿è¾¼ã¿ç¢ºèª
     */
    async function checkTemplateImages() {
      const statusDiv = document.getElementById('templateStatus');
      const shiftChars = ['B', 'C', 'D', 'X', 'Y'];
      let allLoaded = true;
      let html = '<div class="info"><strong>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿çµæœï¼š</strong><br>';

      for (const char of shiftChars) {
        const img = document.getElementById(`template-${char}`);
        try {
          // ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’ç¢ºèª
          if (img.complete && img.naturalHeight > 0) {
            html += `âœ… ${char}: ${img.naturalWidth}Ã—${img.naturalHeight}px<br>`;
          } else {
            html += `âŒ ${char}: èª­ã¿è¾¼ã¿ä¸­ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼<br>`;
            allLoaded = false;
          }
        } catch (e) {
          html += `âŒ ${char}: ã‚¨ãƒ©ãƒ¼ - ${e.message}<br>`;
          allLoaded = false;
        }
      }

      html += allLoaded ? '<br>âœ… ã™ã¹ã¦ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚' : '<br>âŒ ã„ãã¤ã‹ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      html += '</div>';

      statusDiv.innerHTML = html;
    }

    /**
     * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚° + OCRã§ã‚·ãƒ•ãƒˆè¡¨ã‚’è§£æ
     */
    async function analyzeWithTemplateMatching() {
      const fileInput = document.getElementById('uploadImage');
      const file = fileInput.files[0];
      const resultDiv = document.getElementById('result');

      if (!file) {
        resultDiv.innerHTML = '<div class="error">âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        return;
      }

      if (typeof cv === 'undefined') {
        resultDiv.innerHTML = '<div class="error">âŒ OpenCV.jsã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="loading">â³ è§£æä¸­...</div>';

      try {
        // 1. ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        const img = await loadImage(file);
        const src = cv.imread(img);
        const canvas = document.getElementById('canvas');
        
        // 2. ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
        const gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ã§ã‚·ãƒ•ãƒˆæ–‡å­—ã‚’æ¤œå‡º
        const detectedShifts = await detectShiftsWithTemplate(gray);

        // 4. OCRã§æ—¥ä»˜ã‚’æŠ½å‡ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (Object.keys(detectedShifts).length > 0) {
          resultDiv.innerHTML = '<div class="loading">â³ OCRã§æ—¥ä»˜ã‚’æŠ½å‡ºä¸­...</div>';
          await extractDatesWithOCR(file, detectedShifts, src);
        }

        // 5. çµæœã‚’è¡¨ç¤º
        displayResults(detectedShifts, src, canvas);

        // ãƒ¡ãƒ¢ãƒªè§£æ”¾
        src.delete();
        gray.delete();

      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
      }
    }

    /**
     * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’Imageè¦ç´ ã«å¤‰æ›
     */
    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**
     * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã‚·ãƒ•ãƒˆæ–‡å­—ã‚’æ¤œå‡º
     */
    async function detectShiftsWithTemplate(grayImage) {
      const shiftChars = ['B', 'C', 'D', 'X', 'Y'];
      const detectedShifts = {};
      const threshold = parseFloat(document.getElementById('threshold').value);
      const debug = document.getElementById('debugMode')?.checked || false;
      const debugLog = [];

      debugLog.push(`ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°é–‹å§‹ï¼ˆé–¾å€¤: ${threshold.toFixed(2)}ï¼‰`);
      debugLog.push(`ç”»åƒã‚µã‚¤ã‚º: ${grayImage.cols}Ã—${grayImage.rows}px`);

      for (const shiftChar of shiftChars) {
        try {
          const templatePath = `template/${shiftChar}_time.png`;
          const templateImg = new Image();
          
          // ç”»åƒã®èª­ã¿è¾¼ã¿ã‚’Promiseã§ç®¡ç†
          await new Promise((resolve, reject) => {
            templateImg.onload = resolve;
            templateImg.onerror = () => reject(new Error(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ${shiftChar} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`));
            templateImg.src = templatePath;
          });

          const template = cv.imread(templateImg);
          debugLog.push(`[${shiftChar}] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚µã‚¤ã‚º: ${template.cols}Ã—${template.rows}px`);

          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚·ãƒ•ãƒˆè¡¨ã‚ˆã‚Šå¤§ãããªã„ã‹ç¢ºèª
          if (template.cols > grayImage.cols || template.rows > grayImage.rows) {
            debugLog.push(`[${shiftChar}] âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå…ƒç”»åƒã‚ˆã‚Šå¤§ãã„ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™`);
            template.delete();
            continue;
          }

          const templateGray = new cv.Mat();
          cv.cvtColor(template, templateGray, cv.COLOR_RGBA2GRAY);

          // ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ
          const result = new cv.Mat();
          cv.matchTemplate(grayImage, templateGray, result, cv.TM_CCOEFF_NORMED);

          // ãƒ”ãƒ¼ã‚¯ã‚’æ¤œå‡ºï¼ˆOpenCV.jsã¯è¿”ã‚Šå€¤ã¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ï¼‰
          const minMax = cv.minMaxLoc(result);

          debugLog.push(`[${shiftChar}] ãƒãƒƒãƒãƒ³ã‚°ã‚¹ã‚³ã‚¢: ${minMax.maxVal.toFixed(3)}`);

          if (minMax.maxVal > threshold) {
            detectedShifts[shiftChar] = {
              score: minMax.maxVal,
              x: minMax.maxLoc.x,
              y: minMax.maxLoc.y,
              confidence: Math.round(minMax.maxVal * 100)
            };
            debugLog.push(`[${shiftChar}] âœ… æ¤œå‡ºæˆåŠŸï¼ä½ç½®: (${minMax.maxLoc.x}, ${minMax.maxLoc.y})`);
          } else {
            debugLog.push(`[${shiftChar}] âŒ é–¾å€¤ä»¥ä¸‹ï¼ˆã‚¹ã‚³ã‚¢ ${minMax.maxVal.toFixed(3)} < ${threshold.toFixed(2)}ï¼‰`);
          }

          // ãƒ¡ãƒ¢ãƒªè§£æ”¾
          template.delete();
          templateGray.delete();
          result.delete();

        } catch (error) {
          debugLog.push(`[${shiftChar}] âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      }

      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (debug) {
        detectedShifts.debugLog = debugLog.join('\n');
      }

      return detectedShifts;
    }

    /**
     * æ¤œå‡ºçµæœã‚’è¡¨ç¤º
     */
    function displayResults(detectedShifts, originalMat, canvas) {
      const resultDiv = document.getElementById('result');
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’åˆ†é›¢
      const debugLog = detectedShifts.debugLog;
      delete detectedShifts.debugLog;

      // OCRæŠ½å‡ºãƒ‡ãƒ¼ã‚¿ã‚’åˆ†é›¢
      const ocrData = detectedShifts.ocrDates;
      delete detectedShifts.ocrDates;

      if (Object.keys(detectedShifts).length === 0) {
        let html = '<div class="error">âŒ ã‚·ãƒ•ãƒˆæ–‡å­—ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        html += '<div class="info" style="margin-top: 1rem;"><strong>ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼š</strong><br>';
        html += '1. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¢ºèªã§å„ç”»åƒãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª<br>';
        html += '2. ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ç¢ºèªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ‘ã‚¹ã¨å†…å®¹ã‚’ç¢ºèª<br>';
        html += '3. é–¾å€¤ã‚’0.3ï½0.5ã«ä¸‹ã’ã¦ã‚‚ã†ä¸€åº¦è©¦ã™<br>';
        html += '4. ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ONã«ã—ã¦ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹<br>';
        html += '5. ã‚·ãƒ•ãƒˆè¡¨ã®ç”»åƒå“è³ªãŒä½ã„å ´åˆã¯ã€ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãŒé«˜ã„å†™çœŸã‚’è©¦ã™<br>';
        html += '</div>';

        if (debugLog) {
          html += '<div class="info" style="margin-top: 1rem;"><strong>ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼š</strong><br>';
          html += '<pre style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto; font-size: 0.85rem;">' + debugLog + '</pre>';
          html += '</div>';
        }

        resultDiv.innerHTML = html;
        cv.imshow(canvas, originalMat);
        return;
      }

      let html = '<div class="success">âœ… æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ•ãƒˆï¼š</div>';

      // OCRã§æŠ½å‡ºã•ã‚ŒãŸæ—¥ä»˜ã‚’è¡¨ç¤º
      if (ocrData && ocrData.extractedDates.length > 0) {
        html += `
          <div class="info" style="margin-bottom: 1rem;">
            <strong>ğŸ“… OCRã§æŠ½å‡ºã•ã‚ŒãŸæ—¥ä»˜ï¼š</strong><br>
            ${ocrData.extractedDates.join('æ—¥, ')}æ—¥
          </div>
        `;
      }

      html += '<div class="shift-result">';

      // ã‚·ãƒ•ãƒˆæ–‡å­—ã‚’ Yåº§æ¨™ã§ã‚½ãƒ¼ãƒˆï¼ˆä¸Šã‹ã‚‰ä¸‹ã¸ï¼‰
      const sortedShifts = Object.entries(detectedShifts)
        .sort((a, b) => a[1].y - b[1].y);

      for (const [shiftChar, info] of sortedShifts) {
        // ä¸Šå´ã«ã‚ã‚‹é ˜åŸŸã‹ã‚‰æ—¥ä»˜ã‚’æ¨æ¸¬
        const dateHint = estimateDateFromPosition(info.y, originalMat.rows);
        
        html += `
          <div class="shift-item shift-${shiftChar}">
            <strong>${shiftChar}</strong><br>
            <small>ä¿¡é ¼åº¦: ${info.confidence}%</small><br>
            <small style="color: #666;">Yåº§æ¨™: ${info.y}px</small><br>
            <small style="background: #fff3cd; padding: 0.25rem 0.5rem; border-radius: 4px;">
              æ¨å®šæ—¥ä»˜å¸¯: ${dateHint}
            </small>
          </div>
        `;
      }
      html += '</div>';

      if (debugLog) {
        html += '<div class="info" style="margin-top: 1rem;"><strong>ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼š</strong><br>';
        html += '<pre style="background: #f5f5f5; padding: 0.5rem; border-radius: 4px; overflow-x: auto; font-size: 0.85rem;">' + debugLog + '</pre>';
        html += '</div>';
      }

      resultDiv.innerHTML = html;

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç”»åƒã‚’è¡¨ç¤º
      cv.imshow(canvas, originalMat);

      // æ¤œå‡ºç‚¹ã‚’æç”»
      const displayImage = originalMat.clone();
      for (const [shiftChar, info] of Object.entries(detectedShifts)) {
        const color = new cv.Scalar(0, 255, 0, 255);
        const radius = 10;
        const thickness = 2;
        const point = new cv.Point(info.x, info.y);
        cv.circle(displayImage, point, radius, color, thickness);
        cv.putText(displayImage, shiftChar, new cv.Point(info.x - 10, info.y - 20), 
                   cv.FONT_HERSHEY_SIMPLEX, 1, color, 2);
      }
      cv.imshow(canvas, displayImage);
      displayImage.delete();
    }

    /**
     * Yåº§æ¨™ã‹ã‚‰æ¨å®šã•ã‚Œã‚‹æ—¥ä»˜å¸¯ã‚’è¨ˆç®—
     * ã‚·ãƒ•ãƒˆè¡¨ã§ã¯é€šå¸¸ã€æ—¥ä»˜ãŒè¡Œã«å¯¾å¿œã—ã¦ã„ã‚‹
     */
    function estimateDateFromPosition(yPos, imageHeight) {
      // ã‚·ãƒ•ãƒˆè¡¨ã®ä¸€èˆ¬çš„ãªæ§‹é€ ï¼š
      // - ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆæ—¥ä»˜ï¼‰ï¼šä¸Šéƒ¨ 0-80px ç¨‹åº¦
      // - è¡Œã®é«˜ã•ï¼šç´„ 30-40px
      
      const headerHeight = 80;
      const rowHeight = 35;
      
      if (yPos < headerHeight) {
        return 'æ—¥ä»˜è¡Œå†…';
      }
      
      const rowNumber = Math.floor((yPos - headerHeight) / rowHeight);
      const dayRange = Math.min(rowNumber + 1, 31);
      
      // è¤‡æ•°è¡Œåˆ†ã®æ—¥ä»˜ã‚’ã‚«ãƒãƒ¼ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
      const startDay = Math.max(1, dayRange - 1);
      const endDay = Math.min(31, dayRange + 1);
      
      if (startDay === endDay) {
        return `${startDay}æ—¥ä»˜è¿‘`;
      } else {
        return `${startDay}-${endDay}æ—¥ä»˜è¿‘`;
      }
    }

    /**
     * OCRã‚’ä½¿ç”¨ã—ãŸæ—¥ä»˜æŠ½å‡º
     */
    async function extractDatesWithOCR(fileData, detectedShifts, imageMat) {
      try {
        // Tesseract.jsã§å…¨æ–‡OCR
        const { data: { text } } = await Tesseract.recognize(
          fileData,
          'jpn',  // æ—¥æœ¬èª
          { logger: (m) => console.log('OCRé€²æ—:', m) }
        );

        // æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æ•°å­—ï¼ˆæ—¥ä»˜ï¼‰ã‚’æŠ½å‡º
        const dates = text.match(/\d{1,2}/g) || [];
        const uniqueDates = [...new Set(dates.map(d => parseInt(d)).filter(d => d >= 1 && d <= 31))];
        uniqueDates.sort((a, b) => a - b);

        // detectedShiftsã«æ—¥ä»˜æƒ…å ±ã‚’è¿½åŠ 
        if (uniqueDates.length > 0) {
          detectedShifts.ocrDates = {
            extractedDates: uniqueDates,
            rawText: text.substring(0, 500)  // ãƒ‡ãƒãƒƒã‚°ç”¨ã«å…ˆé ­500å­—
          };
        }

      } catch (error) {
        console.warn('OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        // OCRã‚¨ãƒ©ãƒ¼ã¯éè‡´å‘½çš„ãªã®ã§ç¶šè¡Œ
      }
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    window.addEventListener('load', () => {
      console.log('ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç¢ºèªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');
      checkTemplateImages();
    });
  </script>
</body>
</html>
