<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CramShift - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ç‰ˆ</title>
  <style>
    body {
      font-family: "Noto Sans JP", sans-serif;
      padding: 2rem;
      max-width: 1200px;
      margin: auto;
      background: #f7f9fc;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #007bff;
      padding-bottom: 1rem;
    }
    .section {
      margin: 2rem 0;
      padding: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
    }
    .section h2 {
      color: #0056b3;
      margin-top: 0;
    }
    label {
      display: block;
      margin: 1rem 0 0.5rem;
      font-weight: 600;
    }
    input[type="file"], input[type="range"] {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
    }
    button {
      background: #007bff;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      margin: 1rem 0.5rem 1rem 0;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #0056b3;
    }
    .result {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    .shift-result {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    .shift-item {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }
    .shift-item.shift-B { border-left: 4px solid #4CAF50; }
    .shift-item.shift-C { border-left: 4px solid #2196F3; }
    .shift-item.shift-D { border-left: 4px solid #FF9800; }
    .shift-item.shift-X { border-left: 4px solid #9C27B0; }
    .shift-item.shift-Y { border-left: 4px solid #F44336; }
    
    canvas {
      max-width: 100%;
      border: 1px solid #ddd;
      margin: 1rem 0;
      border-radius: 8px;
    }
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    .error {
      background: #ffebee;
      border: 1px solid #ef5350;
      color: #c62828;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .success {
      background: #e8f5e9;
      border: 1px solid #66bb6a;
      color: #2e7d32;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .info {
      background: #e3f2fd;
      border: 1px solid #64b5f6;
      color: #1565c0;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ç‰ˆ - ã‚·ãƒ•ãƒˆè¡¨è§£æ</h1>
    
    <div class="info">
      <strong>ğŸ“Œ èª¬æ˜ï¼š</strong> ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ã‚’ä½¿ã£ã¦ã‚·ãƒ•ãƒˆæ–‡å­—ï¼ˆB, C, D, X, Yï¼‰ã‚’æ¤œå‡ºã—ã€ãã®ä¸Šã«ã‚ã‚‹æ•°å­—ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡ºã™ã‚‹å®Ÿé¨“çš„ãªæ–¹æ³•ã§ã™ã€‚
    </div>

    <div class="section">
      <h2>ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <label for="uploadImage">ã‚·ãƒ•ãƒˆè¡¨ã®ç”»åƒã‚’é¸æŠï¼š</label>
      <input type="file" id="uploadImage" accept="image/*">
      <button onclick="analyzeWithTemplateMatching()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ã§è§£æ</button>
    </div>

    <div class="section">
      <h2>âš™ï¸ è§£æè¨­å®š</h2>
      <label>ãƒãƒƒãƒãƒ³ã‚°é–¾å€¤ï¼ˆ0-1ï¼‰ï¼š</label>
      <input type="range" id="threshold" min="0" max="1" step="0.05" value="0.7">
      <span id="thresholdValue">0.70</span>
      
      <label style="margin-top: 1rem;">æœ€å°ãƒãƒƒãƒã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰ï¼š</label>
      <input type="range" id="minSize" min="5" max="100" step="5" value="20">
      <span id="minSizeValue">20</span>
    </div>

    <div class="section">
      <h2>ğŸ¯ æ¤œå‡ºçµæœ</h2>
      <div id="result"></div>
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <!-- OpenCV.js ã‚’èª­ã¿è¾¼ã¿ -->
  <script async src="https://docs.opencv.org/4.5.2/opencv.js"></script>

  <script>
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
    document.getElementById('threshold').addEventListener('input', (e) => {
      document.getElementById('thresholdValue').textContent = parseFloat(e.target.value).toFixed(2);
    });
    document.getElementById('minSize').addEventListener('input', (e) => {
      document.getElementById('minSizeValue').textContent = e.target.value;
    });

    /**
     * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚° + OCRã§ã‚·ãƒ•ãƒˆè¡¨ã‚’è§£æ
     */
    async function analyzeWithTemplateMatching() {
      const fileInput = document.getElementById('uploadImage');
      const file = fileInput.files[0];
      const resultDiv = document.getElementById('result');

      if (!file) {
        resultDiv.innerHTML = '<div class="error">âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        return;
      }

      if (typeof cv === 'undefined') {
        resultDiv.innerHTML = '<div class="error">âŒ OpenCV.jsã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„...</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="loading">â³ è§£æä¸­...</div>';

      try {
        // 1. ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        const img = await loadImage(file);
        const src = cv.imread(img);
        const canvas = document.getElementById('canvas');
        
        // 2. ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
        const gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒãƒƒãƒãƒ³ã‚°ã§ã‚·ãƒ•ãƒˆæ–‡å­—ã‚’æ¤œå‡º
        const detectedShifts = await detectShiftsWithTemplate(gray);

        // 4. çµæœã‚’è¡¨ç¤º
        displayResults(detectedShifts, src, canvas);

        // ãƒ¡ãƒ¢ãƒªè§£æ”¾
        src.delete();
        gray.delete();

      } catch (error) {
        console.error('Error:', error);
        resultDiv.innerHTML = `<div class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
      }
    }

    /**
     * ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’Imageè¦ç´ ã«å¤‰æ›
     */
    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /**
     * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã‚·ãƒ•ãƒˆæ–‡å­—ã‚’æ¤œå‡º
     */
    async function detectShiftsWithTemplate(grayImage) {
      const shiftChars = ['B', 'C', 'D', 'X', 'Y'];
      const detectedShifts = {};
      const threshold = parseFloat(document.getElementById('threshold').value);

      for (const shiftChar of shiftChars) {
        try {
          const templatePath = `template/${shiftChar}_time.png`;
          const templateImg = await loadImage(templatePath);
          const template = cv.imread(templateImg);
          const templateGray = new cv.Mat();
          cv.cvtColor(template, templateGray, cv.COLOR_RGBA2GRAY);

          // ãƒãƒƒãƒãƒ³ã‚°å®Ÿè¡Œ
          const result = new cv.Mat();
          cv.matchTemplate(grayImage, templateGray, result, cv.TM_CCOEFF_NORMED);

          // ãƒ”ãƒ¼ã‚¯ã‚’æ¤œå‡º
          const minVal = { value: 0 };
          const maxVal = { value: 0 };
          const minLoc = { x: 0, y: 0 };
          const maxLoc = { x: 0, y: 0 };
          
          cv.minMaxLoc(result, minVal, maxVal, minLoc, maxLoc);

          if (maxVal.value > threshold) {
            detectedShifts[shiftChar] = {
              score: maxVal.value,
              x: maxLoc.x,
              y: maxLoc.y,
              confidence: Math.round(maxVal.value * 100)
            };
          }

          // ãƒ¡ãƒ¢ãƒªè§£æ”¾
          template.delete();
          templateGray.delete();
          result.delete();

        } catch (error) {
          console.warn(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ${shiftChar} æ¤œå‡ºå¤±æ•—:`, error);
        }
      }

      return detectedShifts;
    }

    /**
     * æ¤œå‡ºçµæœã‚’è¡¨ç¤º
     */
    function displayResults(detectedShifts, originalMat, canvas) {
      const resultDiv = document.getElementById('result');
      
      if (Object.keys(detectedShifts).length === 0) {
        resultDiv.innerHTML = '<div class="error">âŒ ã‚·ãƒ•ãƒˆæ–‡å­—ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚é–¾å€¤ã‚’ä¸‹ã’ã¦ã¿ã¦ãã ã•ã„ã€‚</div>';
        cv.imshow(canvas, originalMat);
        return;
      }

      let html = '<div class="success">âœ… æ¤œå‡ºã•ã‚ŒãŸã‚·ãƒ•ãƒˆï¼š</div>';
      html += '<div class="shift-result">';

      for (const [shiftChar, info] of Object.entries(detectedShifts)) {
        html += `
          <div class="shift-item shift-${shiftChar}">
            <strong>${shiftChar}</strong><br>
            <small>ä¿¡é ¼åº¦: ${info.confidence}%</small><br>
            <small style="color: #666;">Yåº§æ¨™: ${info.y}px</small>
          </div>
        `;
      }
      html += '</div>';

      html += '<p><strong>ğŸ“ æ³¨ï¼š</strong> ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚·ãƒ•ãƒˆæ–‡å­—ã®æ¤œå‡ºã®ã¿ã§ã™ã€‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€æ¤œå‡ºã—ãŸæ–‡å­—ã®ä¸Šå´ã«ã‚ã‚‹æ•°å­—ã‚’èªè­˜ã—ã¦æ—¥ä»˜ã‚’æŠ½å‡ºã—ã¾ã™ã€‚</p>';

      resultDiv.innerHTML = html;

      // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ç”»åƒã‚’è¡¨ç¤º
      cv.imshow(canvas, originalMat);

      // æ¤œå‡ºç‚¹ã‚’æç”»
      const displayImage = originalMat.clone();
      for (const [shiftChar, info] of Object.entries(detectedShifts)) {
        const color = new cv.Scalar(0, 255, 0, 255);
        const radius = 10;
        const thickness = 2;
        const point = new cv.Point(info.x, info.y);
        cv.circle(displayImage, point, radius, color, thickness);
        cv.putText(displayImage, shiftChar, new cv.Point(info.x - 10, info.y - 20), 
                   cv.FONT_HERSHEY_SIMPLEX, 1, color, 2);
      }
      cv.imshow(canvas, displayImage);
      displayImage.delete();
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”»åƒã‚’ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
    window.addEventListener('load', () => {
      const shiftChars = ['B', 'C', 'D', 'X', 'Y'];
      shiftChars.forEach(char => {
        const img = new Image();
        img.src = `template/${char}_time.png`;
      });
    });
  </script>
</body>
</html>
